# n8n集成指南

## 概述

古诗文学习平台已完全集成n8n工作流引擎，实现智能化、自动化的学习体验。

## 🔧 已集成的工作流

### 1. AI智能推荐工作流
- **端点**: `POST /api/n8n/get-recommendations`
- **功能**: 基于用户偏好和学习历史，推荐合适的诗词
- **输入**: 用户ID、学习偏好（难度、朝代等）
- **输出**: 个性化推荐的诗词列表

### 2. 学习进度追踪工作流
- **端点**: `POST /api/n8n/track-progress`
- **功能**: 记录用户学习行为，更新学习统计
- **输入**: 用户ID、诗词ID、学习行为、得分
- **输出**: 更新后的学习数据

### 3. AI内容生成工作流
- **端点**: `POST /api/n8n/generate-poem`
- **功能**: 根据主题和风格生成新的诗词
- **输入**: 主题、风格、难度要求
- **输出**: AI生成的诗词内容

### 4. AI图片生成工作流
- **端点**: `POST /api/n8n/generate-image` 
- **功能**: 为诗词生成配套的古风背景图片
- **输入**: 诗词ID、描述文本
- **输出**: 生成的图片URL

## 🚀 启动和配置

### 1. 启动n8n服务
```bash
# 在项目根目录执行
npx n8n start

# n8n将在 http://localhost:5678 启动
```

### 2. 导入工作流
1. 访问 http://localhost:5678
2. 创建新的工作流
3. 导入 `n8n-workflows/` 目录下的工作流文件
4. 配置webhook端点
5. 激活工作流

### 3. 环境变量配置
```bash
# backend/.env
N8N_URL=http://localhost:5678
N8N_WEBHOOK_URL=http://localhost:5678/webhook
```

## 📊 监控和状态

### n8n服务状态检查
```bash
GET /api/n8n/status
```

返回示例：
```json
{
  "success": true,
  "data": {
    "status": "connected",
    "activeWorkflows": 4
  }
}
```

### 前端状态指示器
- 🟢 绿色：n8n服务已连接，工作流正常
- 🔴 红色：n8n服务未连接或出现故障

## 🎯 实际应用场景

### 场景1: 用户进入首页
1. 前端调用 `/api/n8n/get-recommendations`
2. n8n分析用户偏好（如果是新用户则使用默认偏好）
3. 返回3-5首推荐诗词
4. 前端展示"AI智能推荐"区域

### 场景2: 用户完成诗词学习
1. 前端调用 `/api/n8n/track-progress`
2. n8n记录学习行为（完成时间、得分等）
3. 触发推荐算法更新
4. 为用户推荐下一首适合的诗词

### 场景3: 教师生成新内容
1. 教师在管理界面输入主题和要求
2. 调用 `/api/n8n/generate-poem`
3. n8n调用OpenAI API生成诗词
4. 同时调用 `/api/n8n/generate-image` 生成配图
5. 将新内容添加到诗词库

## 🔧 开发和扩展

### 添加新的工作流
1. 在n8n界面创建新工作流
2. 配置webhook触发器
3. 在后端添加对应的API端点
4. 在前端调用新的API

### 工作流最佳实践
- 使用错误处理节点捕获异常
- 配置重试机制应对网络问题
- 记录执行日志便于调试
- 使用条件分支处理不同场景

## 📈 性能优化

- 配置工作流缓存减少重复计算
- 使用异步执行避免阻塞
- 监控工作流执行时间
- 定期清理执行历史

## 🛠️ 故障排除

### 常见问题
1. **n8n服务启动失败**
   - 检查端口5678是否被占用
   - 确认n8n版本兼容性

2. **工作流执行超时**
   - 检查网络连接
   - 增加超时时间配置

3. **webhook无法接收请求**
   - 确认防火墙设置
   - 检查URL路径配置
